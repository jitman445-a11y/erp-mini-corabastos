<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ERP Pedidos</title>
<style>
  body{font-family:Arial;background:#f4f6f9;margin:0;padding:20px;}
  .card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1);max-width:600px;margin:auto;}
  input,button{width:100%;padding:10px;margin:5px 0;border-radius:6px;border:1px solid #ccc;}
  button{background:#0a57ff;color:#fff;border:none;cursor:pointer;}
  #items{margin-top:10px;}
</style>
</head>
<body>
<div class="card">
  <h2>Nuevo Pedido</h2>

  <label>NIT</label>
  <input id="nit" oninput="autofillPedido(this.value)" />

  <label>Nombre Fundaci칩n</label>
  <input id="nombre_fundacion" oninput="autofillPedido(this.value)" />

  <label>Punto de Env칤o</label>
  <input id="punto_envio" oninput="autofillPedido(this.value)" />

  <label>Items</label>
  <div id="items"></div>
  <button onclick="agregarItem()">Agregar Item</button>

  <button onclick="guardarPedido()">Guardar Pedido</button>
  <button onclick="duplicarPedido()">Duplicar Pedido</button>
</div>

<script>
// === PREFIJO Y CONSECUTIVO ===
const PREFIJO_CUSTOM = "PED";
const PREFIJO_ANIO = new Date().getFullYear();

function getUltimoConsecutivo(){
  const data = JSON.parse(localStorage.getItem("consecutivo_pedido")||"{}");
  return data.numero ? parseInt(data.numero) : 0;
}

function setUltimoConsecutivo(num){
  localStorage.setItem("consecutivo_pedido",JSON.stringify({anio:PREFIJO_ANIO,numero:num}));
}

function verificarReset(){
  const data = JSON.parse(localStorage.getItem("consecutivo_pedido")||"{}");
  if(!data.anio || data.anio!==PREFIJO_ANIO){ setUltimoConsecutivo(0); }
}

function generarConsecutivo(){
  verificarReset();
  let n = getUltimoConsecutivo()+1;
  setUltimoConsecutivo(n);
  return `${PREFIJO_CUSTOM}-${PREFIJO_ANIO}-${String(n).padStart(4,'0')}`;
}

// === FUNDACIONES HARDCODE ===
let FUNDACIONES=[
 {nit:"900123456",nombre:"Fundaci칩n Sol",sucursal:"Bogot치"},
 {nit:"800987654",nombre:"Fundaci칩n Luna",sucursal:"Medell칤n"}
];

// Buscar por NIT o coincidencia en nombre o sucursal
function buscarFundacion(v){
  v = String(v || '').toLowerCase();
  return FUNDACIONES.find(f=> 
    String(f.nit).toLowerCase()===v ||
    String(f.nombre).toLowerCase().includes(v) ||
    String(f.sucursal).toLowerCase().includes(v)
  );
}

function buscarSucursal(v){
  v = String(v || '').toLowerCase();
  return FUNDACIONES.find(f=> 
    String(f.sucursal).toLowerCase()===v ||
    String(f.nombre).toLowerCase().includes(v) ||
    String(f.nit).toLowerCase().includes(v)
  );
}

function autofillPedido(v){
  const f = buscarFundacion(v);
  if(f){
    // use element references safely
    const nitEl = document.getElementById('nit');
    const nombreEl = document.getElementById('nombre_fundacion');
    const puntoEl = document.getElementById('punto_envio');
    if(nitEl) nitEl.value = f.nit;
    if(nombreEl) nombreEl.value = f.nombre;
    if(puntoEl) puntoEl.value = f.sucursal;
  }
}

// === ITEMS ===
function agregarItem(){
  const container = document.getElementById('items');
  if(!container) return;
  const div=document.createElement('div');
  div.style.display = 'flex';
  div.style.gap = '8px';
  div.innerHTML=`<input class='prod' placeholder='Producto' oninput="autocompleteProducto(this)" style='flex:1' /><input class='cant' placeholder='Cantidad' oninput="autocompleteCantidad(this)" style='width:120px'/>`;
  container.appendChild(div);
}

// === AUTOCOMPLETAR PRODUCTOS ===
const PRODUCTOS = [
  "Leche en polvo",
  "Arroz",
  "Frijol",
  "Aceite",
  "At칰n",
  "Cereal",
  "Pa침ales",
  "Jab칩n l칤quido",
  "Detergente",
  "Toallas higi칠nicas"
];

function autocompleteProducto(input){
  const v = String(input.value || '').toLowerCase();
  const match = PRODUCTOS.find(p => p.toLowerCase().includes(v));
  input.style.background = match ? "#e6f0ff" : "white";
}

// === AUTOCOMPLETAR CANTIDADES ===
const CANTIDADES = ["Unidad","Caja","Bolsa","Paquete","Docena","Saco","Botella","Gal칩n"];
function autocompleteCantidad(input){
  const v = String(input.value || '').toLowerCase();
  const match = CANTIDADES.find(c => c.toLowerCase().includes(v));
  input.style.background = match ? "#e6f0ff" : "white";
}

// === PEDIDOS LS ===
function guardarPedido(){
  const nEl = document.getElementById('nit');
  const nomEl = document.getElementById('nombre_fundacion');
  const sucEl = document.getElementById('punto_envio');
  const n = nEl ? nEl.value.trim() : '';
  const nom = nomEl ? nomEl.value.trim() : '';
  const suc = sucEl ? sucEl.value.trim() : '';

  // 游뛂 no permitir fundaci칩n duplicada por NIT
  const existe = FUNDACIONES.some(f => String(f.nit) === String(n));
  if(!existe && n){
    FUNDACIONES.push({nit:n, nombre:nom, sucursal:suc});
  }

  const container = document.getElementById('items');
  const itemsArr = container ? [...container.querySelectorAll('div')].map(d=>{
    const inputs = d.querySelectorAll('input');
    const p = inputs[0] ? inputs[0].value : '';
    const c = inputs[1] ? inputs[1].value : '';
    return {producto:p,cantidad:c};
  }) : [];

  const pedido={
    id:generarConsecutivo(),
    nit:n,
    nombre:nom,
    envio:suc,
    items: itemsArr
  };
  let p = JSON.parse(localStorage.getItem('pedidos')||'[]');
  p.push(pedido);
  localStorage.setItem('pedidos',JSON.stringify(p));
  alert(`Pedido guardado: ${pedido.id}`);
}

let pedidoDuplicado=null;

function duplicarPedido(){
  let p = JSON.parse(localStorage.getItem('pedidos')||'[]');
  if(p.length===0){alert('No hay pedidos');return;}
  pedidoDuplicado = p[p.length-1];
  const nitEl = document.getElementById('nit');
  const nomEl = document.getElementById('nombre_fundacion');
  const puntoEl = document.getElementById('punto_envio');
  if(nitEl) nitEl.value = '';
  if(nomEl) nomEl.value = '';
  if(puntoEl) puntoEl.value = '';
  const container = document.getElementById('items');
  if(container) container.innerHTML = '';
  (pedidoDuplicado.items || []).forEach(i=>{
    const div=document.createElement('div');
    div.style.display = 'flex';
    div.style.gap = '8px';
    const prod = document.createElement('input'); prod.value = i.producto || ''; prod.placeholder='Producto'; prod.className='prod'; prod.oninput = function(){ autocompleteProducto(this); };
    const cant = document.createElement('input'); cant.value = i.cantidad || ''; cant.placeholder='Cantidad'; cant.className='cant'; cant.oninput = function(){ autocompleteCantidad(this); };
    prod.style.flex='1'; cant.style.width='120px';
    div.appendChild(prod); div.appendChild(cant);
    container.appendChild(div);
  });
  alert('Pedido duplicado, modifique datos y guarde');
}


// === AUTOCOMPLETAR CREAR SUCURSAL DESDE NIT ===
function autoCompletarCrearSucursal() {
  const nit = document.getElementById("f_nit").value.trim();
  if (!nit) {
    const fn = document.getElementById("f_name");
    if(fn) fn.value = "";
    return;
  }
  const fundaciones = JSON.parse(localStorage.getItem("Fundaciones")||"[]");
  const fund = fundaciones.find(f => String(f.nit).toLowerCase() === nit.toLowerCase());
  if (fund) {
    const fn = document.getElementById("f_name");
    if(fn) fn.value = fund.nombre || fund.name || "";
  }
}

document.addEventListener("DOMContentLoaded",()=>{
  const el = document.getElementById("f_nit");
  if(el) el.addEventListener("input", autoCompletarCrearSucursal);
});

</script>
</body>
</html>
