<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ERP Corabastos — V4 (Estable)</title>
<style>
:root{--bg:#f4f6f9;--panel:#0b1220;--accent:#0a57ff;--card:#ffffff}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#0f172a}
header{background:#071025;color:#fff;padding:10px 16px;display:flex;justify-content:space-between;align-items:center}
.app{display:flex;height:calc(100vh - 50px)}
#sidebar{width:240px;background:var(--panel);color:#fff;padding:16px;display:flex;flex-direction:column;gap:8px}
#sidebar button{background:transparent;border:0;color:#cbd5e1;text-align:left;padding:8px;border-radius:6px;cursor:pointer}
#sidebar button:hover{background:rgba(255,255,255,0.04)}
#sidebar button.active{background:rgba(255,255,255,0.06);color:#fff;font-weight:700}
main{flex:1;padding:20px;overflow:auto}
.card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 4px 14px rgba(0,0,0,0.06);margin-bottom:16px}
input,select,textarea{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #d0d6e1}
button.primary{background:var(--accent);color:#fff;padding:8px 12px;border:0;border-radius:6px;cursor:pointer}
.small{font-size:13px;color:#6b7280}.hidden{display:none!important}
.table{width:100%;border-collapse:collapse}.table th,.table td{padding:8px;border-bottom:1px solid #eef4fb;text-align:left}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:60}
.modal .card{width:100%;max-width:420px}
@media(max-width:900px){#sidebar{position:fixed;left:0;top:50px;bottom:0;transform:translateX(-100%);transition:transform .22s;z-index:40}#sidebar.open{transform:translateX(0)}main{padding:12px}}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#0a57ff;font-weight:600;font-size:12px}
.actions-row{display:flex;gap:8px;flex-wrap:wrap}
.item-row{display:flex;gap:8px;align-items:center}
.alert {padding:8px;border-radius:6px;background:#fff4e5;color:#8a4b00;border:1px solid #ffd9a8;margin-top:8px}
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <button id="btnMenu" class="primary" style="background:transparent;border:0;color:#fff">☰</button>
    <div style="font-size:18px;font-weight:700">ERP Corabastos</div>
  </div>
  <div style="display:flex;align-items:center;gap:12px">
    <div class="small" id="headerUser">Invitado</div>
    <button id="btnLogout" class="primary hidden">Cerrar sesión</button>
  </div>
</header>
<div class="app">
  <aside id="sidebar">
    <button data-sec="dashboard">Dashboard</button>
    <button data-sec="fundaciones">Fundaciones</button>
    <button data-sec="items">Items</button>
    <button data-sec="conductores">Conductores</button>
    <button data-sec="recibos">Pedidos</button>
    <button data-sec="search">Buscar</button>
    <hr style="border-color:rgba(255,255,255,0.04);">
    <button data-sec="usuarios">Mi Cuenta</button>
    <button data-sec="admin_users" id="btnAdminUsers">Usuarios (Admin)</button>
    <button data-sec="auditoria">Auditoría</button>
    <button data-sec="seguimiento">Seguimiento</button>
    <button data-sec="roles">Gestión Roles</button>
  </aside>
  <main id="main">

    <section id="dashboard" class="card">
      <h2>Bienvenido</h2>
      <p class="small">Versión estable. Inicie sesión para usar el sistema.</p>
    </section>

    <section id="fundaciones" class="hidden">
      <h2>Fundaciones</h2>
      <div class="card">
        <h3>Crear Fundación</h3>
        <label>NIT</label><input id="f_nit" placeholder="NIT (ej: 900123456)">
        <label>Nombre</label><input id="f_name" placeholder="Nombre de la fundación">
        <div id="f_warn" class="small" style="margin-top:6px;color:#9a3412"></div>
        <button id="btnFundCreate" class="primary" style="margin-top:10px">Crear Fundación</button>
      </div>

      <div class="card">
        <h3>Añadir Punto de Envío</h3>
        <!-- agregado: campo NIT opcional para autoseleccionar fundación -->
        <label>NIT Fundación (opcional)</label><input id="p_fund_nit" placeholder="Ingresar NIT para autoseleccionar">
        <div id="p_fund_info" class="small" style="margin-top:6px"></div>

        <label>Fundación</label><select id="selFund"></select>
        <label>Barrio</label><input id="p_barrio">
        <label>Localidad</label><input id="p_localidad">
        <label>Ciudad</label><input id="p_ciudad">
        <label>Teléfono 1</label><input id="p_tel1">
        <label>Teléfono 2</label><input id="p_tel2">
        <label>Encargada</label><input id="p_encargada">
        <div id="p_warn" class="small" style="margin-top:6px;color:#9a3412"></div>
        <button id="btnPointCreate" class="primary" style="margin-top:10px">Agregar Punto</button>
      </div>

      <div class="card">
        <h3>Cargar Fundaciones desde Excel</h3>
        <input id="excel_fundaciones" type="file" accept=".xlsx,.xls">
        <button id="btnImportFund" class="primary" style="margin-top:10px">Importar Excel</button>
      </div>

      <div class="card">
        <h3>Listado</h3>
        <input id="searchFund" placeholder="Buscar fundaciones..." style="margin-bottom:10px">
        <div id="fundList"></div>
      
      </div>
    </section>

    <section id="items" class="hidden">
      <h2>Items</h2>
      <div class="card">
        <label>Referencia</label><input id="item_ref">
        <label>Nombre</label><input id="item_name">
        <label>Descripción</label><input id="item_desc">
        <label>Precio</label><input id="item_price" type="number">
        <button id="btnCreateItem" class="primary" style="margin-top:10px">Agregar Item</button>
      </div>

      <div class="card">
        <h3>Cargar Items desde Excel</h3>
        <input id="excel_items" type="file" accept=".xlsx,.xls">
        <button id="btnImportItems" class="primary" style="margin-top:10px">Importar Excel</button>
      </div>

      <div class="card">
        <h3>Gestionar Embalajes</h3>
        <input id="new_pack" placeholder="Nuevo embalaje">
        <button id="btnAddPack" class="primary" style="margin-top:10px">Agregar</button>
        <ul id="packList" class="small" style="padding-left:18px;margin-top:10px"></ul>
      </div>

      <div class="card">
        <h3>Listado de Items</h3>
        <input id="searchItems" placeholder="Buscar..." style="margin-bottom:10px">
        <table class="table" id="itemsTable">
          <thead>
            <tr><th>Ref</th><th>Nombre</th><th>Descripción</th><th>Precio</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section id="conductores" class="hidden">
      <h2>Conductores y Placas</h2>
      <div class="card">
        <label>Nombre</label><input id="drv_name">
        <label>Documento</label><input id="drv_doc">
        <label>Teléfono</label><input id="drv_tel">
        <label>Empresa</label><input id="drv_cmp">
        <button id="btnAddDriver" class="primary" style="margin-top:10px">Agregar Conductor</button>
      </div>

      <div class="card">
        <h3>Agregar Placa</h3>
        <label>Placa</label><input id="pl_plate">
        <label>Tipo</label><input id="pl_type">
        <button id="btnAddPlate" class="primary" style="margin-top:10px">Agregar</button>
      </div>

      <div class="card">
        <h3>Conductores</h3>
        <input id="searchDrivers" placeholder="Buscar..." style="margin-bottom:10px">
        <ul id="driversList"></ul>
      </div>

      <div class="card">
        <h3>Placas</h3>
        <input id="searchPlates" placeholder="Buscar..." style="margin-bottom:10px">
        <ul id="platesList"></ul>
      </div>
    </section>

    <section id="search" class="hidden">
      <h2>Buscador Global</h2>
      <input id="globalSearch" placeholder="Buscar..." style="margin-bottom:10px">
      <div id="globalResults"></div>
    </section>

    <section id="recibos" class="hidden">
      <h2>Pedidos</h2>
      <div class="card">
        <h3 id="formTitle">Crear Pedido</h3>

        <label>NIT Fundación</label>
        <input id="pd_nit" placeholder="NIT">

        <div id="pd_fund_info" class="small" style="margin-top:6px"></div>

        <label>Fundación (seleccione)</label><select id="pd_fund"></select>
        <label>Punto de Envío</label><select id="pd_point"></select>

        <label>Conductor</label><select id="pd_driver"></select>
        <label>Placa</label><select id="pd_plate"></select>
        <label>Peaje</label><input id="pd_peaje" type="number">
        <label>Costo de Transporte</label><input id="pd_trans" type="number">

        <h3 style="margin-top:12px">Agregar Items</h3>
        <label>Item</label>
        <select id="pd_item_sel" style="width:100%;margin-bottom:6px"></select>
        <label>Embalaje (opcional)</label>
        <select id="pd_pack_sel" style="width:100%;margin-bottom:6px"></select>
        <label>Cantidad de Embalaje</label>
        <input id="pd_pack_qty" type="number" placeholder="Cant. Embalaje" value="1">
        <label>Kilos (obligatorio)</label>
        <input id="pd_kilos" type="number" placeholder="Kilos (obligatorio)">

        <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
          <button id="pd_add_item" class="primary">Agregar producto</button>
          <button id="btnAddProducto" class="primary">Agregar fila manual</button>
        </div>

        <ul id="pd_items_list" style="margin-top:10px"></ul>

        <div style="display:flex;gap:8px;margin-top:12px">
          <button id="btnAddPedido" class="primary">Guardar Pedido</button>
          <button id="btnExportPedidoCSV" class="primary">Exportar CSV</button>
          <button id="btnExportPedidoIMG" class="primary">Exportar Imagen</button>
          <div class="small" id="pedidoModoBadge" style="align-self:center"></div>
        </div>
      </div>

      <div class="card">
        <h3>Listado de Pedidos (historial)</h3>
        <input id="searchPedidos" placeholder="Buscar..." style="margin-bottom:10px">
        <ul id="pedidosList"></ul>
      </div>
    </section>

    <section id="usuarios" class="hidden">
      <h2>Mi Cuenta</h2>
      <div class="card">
        <label>Usuario (no editable)</label>
        <input id="usr_username" disabled>
        <label>Nombre completo</label><input id="usr_fullname">
        <label>Teléfono</label><input id="usr_phone">
        <label>Correo</label><input id="usr_email">
        <label>Contraseña</label><input id="usr_password" type="password">
        <button id="btnUserPassSave" class="primary" style="margin-top:10px">Guardar</button>
      </div>
    </section>

    <section id="admin_users" class="hidden">
      <h2>Gestión de Usuarios (Admin)</h2>
      <div class="card">
        <label>Nuevo Usuario</label>
        <input id="adm_new_user" placeholder="Usuario">
        <label>Contraseña</label>
        <input id="adm_new_pass" type="password">
        <label>Rol</label>
        <select id="adm_new_role"><option value="general">General</option><option value="admin">Administrador</option><option value="lector">Lector</option></select>
        <button id="adm_add_user" class="primary" style="margin-top:10px">Crear Usuario</button>
      </div>
      <div class="card">
        <h3>Usuarios Registrados</h3>
        <ul id="adm_user_list" class="small" style="padding-left:18px"></ul>
      </div>
    </section>

    <section id="auditoria" class="hidden">
      <h2>Auditoría</h2>
      <div class="card">
        <label>Filtrar por usuario</label>
        <input id="auditUserFilter" placeholder="Usuario">
        <label>Filtrar por fecha</label>
        <input id="auditDateFilter" type="date">
      </div>
      <div id="auditList" class="card small"></div>
    </section>

    <section id="seguimiento" class="hidden">
      <h2>Seguimiento</h2>
      <div class="card">
        <table class="table" id="segTable"><thead><tr><th>Fecha</th><th>Fundación</th><th>Barrio</th><th>Kilos</th><th>Conductor</th></tr></thead><tbody></tbody></table>
      </div>
    </section>

    <section id="roles" class="hidden">
      <h2>Roles</h2>
      <div class="card small">Gestión de roles disponible para administrador.</div>
    </section>

  </main>
</div>

<!-- LOGIN modal (required) -->
<div id="loginModal" class="modal hidden">
  <div class="card">
    <h3>Iniciar sesión</h3>
    <label>Usuario</label><input id="login_user">
    <label>Contraseña <small style="color:#6b7280">(<a href="#" id="togglePass">mostrar</a>)</small></label>
    <input id="login_pass" type="password">
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <button id="btnLogin" class="primary">Ingresar</button>
      <div id="loginStatus" class="small" style="color:#6b7280"></div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',function(){
  const $ = id => document.getElementById(id);

  // state init (same storage key erp_state)
  let state = JSON.parse(localStorage.getItem('erp_state')||'null') || {};
  state.users = Array.isArray(state.users)? state.users : [
    {username:'admin',pass:'3134630773',role:'admin',fullname:'Administrador'},
    {username:'jgarnica',pass:'12345',role:'general',fullname:''},
    {username:'jnonato',pass:'12345',role:'general',fullname:''},
    {username:'salidas',pass:'12345',role:'general',fullname:''},
    {username:'mcarabali',pass:'12345',role:'general',fullname:''}
  ];
  state.currentUser = state.currentUser || null;
  state.foundations = Array.isArray(state.foundations)? state.foundations : []; // each: {nit,name,points: [{barrio,localidad,ciudad,tel1,tel2,encargada}]}
  state.items = Array.isArray(state.items)? state.items : [];
  state.packs = Array.isArray(state.packs)? state.packs : ['Atado','Bulto','Canastilla','Caja','Unidad'];
  state.drivers = Array.isArray(state.drivers)? state.drivers : [];
  state.plates = Array.isArray(state.plates)? state.plates : [];
  state.pedidos = Array.isArray(state.pedidos)? state.pedidos : [];
  state.audit = Array.isArray(state.audit)? state.audit : [];

  function save(){ localStorage.setItem('erp_state', JSON.stringify(state)); }

  function registrarAccion(accion,detalle){ const rec={fecha:new Date().toISOString(),usuario: state.currentUser?state.currentUser.username:'-',accion,detalle}; state.audit.unshift(rec); save(); renderAudit(); }

  // Pedido globals
  let modoPedido = 'crear';
  let pedidoEditandoId = null;
  let currentPedidoItems = [];
  const PREFIJO_CUSTOM = "PED";

  function obtenerConsecutivoPedidoPorAnio(){
    const anioActual = new Date().getFullYear().toString();
    const key = 'consecutivo_pedido';
    const data = JSON.parse(localStorage.getItem(key) || '{}');
    let numero = 0;
    if(!data.anio || data.anio !== anioActual){
      numero = 1;
    } else {
      numero = parseInt(data.numero || 0) + 1;
    }
    localStorage.setItem(key, JSON.stringify({ anio: anioActual, numero: numero }));
    return `${PREFIJO_CUSTOM}-${anioActual}-${String(numero).padStart(4,'0')}`;
  }

  // UI helpers
  function showSection(id){ document.querySelectorAll('main section').forEach(s=>s.classList.add('hidden')); const el = $(id); if(el) el.classList.remove('hidden'); document.querySelectorAll('#sidebar button').forEach(b=>b.classList.remove('active')); const btn=document.querySelector('#sidebar button[data-sec="'+id+'"]'); if(btn) btn.classList.add('active'); window.scrollTo(0,0); }
  document.querySelectorAll('#sidebar button').forEach(b=> b.addEventListener('click', ()=> { showSection(b.dataset.sec); document.getElementById('sidebar').classList.remove('open'); }));
  $('btnMenu').addEventListener('click', ()=> document.getElementById('sidebar').classList.toggle('open'));
  document.addEventListener('click', (e)=>{ const sb = document.getElementById('sidebar'); const btn = document.getElementById('btnMenu'); if(sb.classList.contains('open') && !sb.contains(e.target) && e.target!==btn){ sb.classList.remove('open'); } });

  // Login modal
  function openLogin(){ $('loginModal').classList.remove('hidden'); }
  function closeLogin(){ $('loginModal').classList.add('hidden'); }
  $('togglePass').addEventListener('click', function(ev){ ev.preventDefault(); const p=$('login_pass'); p.type = p.type === 'password' ? 'text' : 'password'; this.textContent = p.type==='password'? 'mostrar':'ocultar'; });

  function setCurrentUser(user){ state.currentUser = user; save(); $('headerUser').innerText = user.username + ' ('+user.role+')'; $('btnLogout').classList.remove('hidden'); if(user.role !== 'admin') { $('btnAdminUsers').style.display = 'none'; } else { $('btnAdminUsers').style.display = 'block'; } closeLogin(); renderAll(); showSection('dashboard'); }
  $('btnLogin').addEventListener('click', function(){ const u = $('login_user').value.trim(); const p = $('login_pass').value.trim(); if(!u || !p){ alert('Usuario y clave requeridos'); return; } $('loginStatus').innerText = 'Iniciando...'; setTimeout(()=>{ const found = state.users.find(x=>x.username===u && x.pass===p); if(!found){ alert('Usuario o clave incorrectos'); $('loginStatus').innerText=''; return; } setCurrentUser(found); registrarAccion('login',{user:u}); $('login_user').value=''; $('login_pass').value=''; $('loginStatus').innerText=''; },600); });
  $('btnLogout').addEventListener('click', function(){ if(confirm('Cerrar sesión?')){ state.currentUser = null; save(); $('headerUser').innerText = 'Invitado'; $('btnLogout').classList.add('hidden'); openLogin(); } });
  if(!state.currentUser){ openLogin(); } else { setCurrentUser(state.currentUser); }

  // Fillers/renderers
  function fillFundSelects(){
    const sel = $('selFund');
    if(sel){
      sel.innerHTML='';
      state.foundations.forEach((f,i)=> sel.appendChild(new Option(f.name+' ('+f.nit+')', i)));
    }
    const pf = $('pd_fund');
    if(pf){
      pf.innerHTML='';
      state.foundations.forEach((f,i)=> pf.appendChild(new Option(f.name, i)));
      // Keep pd_fund value if possible, else reset
      if(pf.options.length===0) pf.value='';
    }
    fillPedidoPoints();
  }

  function fillPedidoPoints(){
    const sel=$('pd_point'); if(!sel) return;
    sel.innerHTML='';
    const pf = $('pd_fund');
    const fi = pf && pf.value !== '' ? Number(pf.value) : null;
    const f = (fi!==null && state.foundations[fi]) ? state.foundations[fi] : null;
    if(f && Array.isArray(f.points)){
      f.points.forEach((p,i)=> sel.appendChild(new Option(p.barrio+' ('+p.localidad+' - '+p.ciudad+')', i)));
      // si solo hay 1 punto, autoselect
      if(f.points.length === 1){
        sel.value = 0;
      }
    } else {
      sel.innerHTML = '';
    }
  }

  function fillItemSelect(){ const sel=$('pd_item_sel'); if(!sel) return; sel.innerHTML=''; state.items.forEach((it,i)=> sel.appendChild(new Option(it.name+' - $'+it.price, i))); }
  function fillPackSelect(){ const sel=$('pd_pack_sel'); if(!sel) return; sel.innerHTML=''; sel.appendChild(new Option('','')); state.packs.forEach(p=> sel.appendChild(new Option(p,p))); }
  function fillDriverPlate(){ const sd=$('pd_driver'); const sp=$('pd_plate'); if(sd){ sd.innerHTML=''; state.drivers.forEach((d,i)=> sd.appendChild(new Option(d.name,i))); } if(sp){ sp.innerHTML=''; state.plates.forEach((p,i)=> sp.appendChild(new Option(p.plate,i))); } }

  function renderFund(){ const box=$('fundList'); if(!box) return; box.innerHTML=''; state.foundations.forEach((f,idx)=>{ const d=document.createElement('div'); d.className='card'; d.style.marginBottom='8px'; let html = '<strong>'+escapeHtml(f.name)+'</strong><div class="small">NIT: '+escapeHtml(f.nit)+'</div>'; if(Array.isArray(f.points) && f.points.length){ html += '<div style="margin-top:8px">'; f.points.forEach((p)=>{ html += '<div class="small">'+escapeHtml(p.barrio)+' — '+escapeHtml(p.localidad)+' — '+escapeHtml(p.ciudad)+' — '+escapeHtml(p.encargada||'')+'</div>'; }); html += '</div>'; } else { html += '<div class="small">Sin puntos</div>'; } d.innerHTML = html; box.appendChild(d); }); }

  function renderItems(){ const tbody = $('itemsTable').querySelector('tbody'); tbody.innerHTML=''; state.items.forEach((it,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = '<td>'+escapeHtml(it.ref)+'</td><td>'+escapeHtml(it.name)+'</td><td>'+(escapeHtml(it.desc||''))+'</td><td>$'+(it.price||0)+'</td><td><button data-i="'+i+'" class="delItem">Eliminar</button></td>'; tbody.appendChild(tr); }); document.querySelectorAll('.delItem').forEach(btn=> btn.addEventListener('click', function(){ if(!state.currentUser || state.currentUser.role!=='admin'){ return alert('Solo admin puede eliminar'); } const idx=Number(this.dataset.i); state.items.splice(idx,1); save(); renderItems(); fillItemSelect(); registrarAccion('eliminar_item',{index:idx}); })); }

  function renderPacks(){ const ul=$('packList'); if(!ul) return; ul.innerHTML=''; state.packs.forEach((p,i)=>{ const li=document.createElement('li'); li.textContent = p + ' '; const del=document.createElement('button'); del.textContent='Eliminar'; del.style.marginLeft='8px'; del.addEventListener('click', ()=>{ if(!state.currentUser || state.currentUser.role!=='admin') return alert('Solo admin'); state.packs.splice(i,1); save(); renderPacks(); }); li.appendChild(del); ul.appendChild(li); }); }

  function renderDrivers(){ const ul=$('driversList'); if(!ul) return; ul.innerHTML=''; state.drivers.forEach((d,i)=>{ const li=document.createElement('li'); li.textContent = d.name + ' — ' + (d.document||''); ul.appendChild(li); }); }
  function renderPlates(){ const ul=$('platesList'); if(!ul) return; ul.innerHTML=''; state.plates.forEach((p,i)=>{ const li=document.createElement('li'); li.textContent = p.plate + ' ('+(p.type||'')+')'; ul.appendChild(li); }); }

  function refreshPdItems(){ const ul=$('pd_items_list'); if(!ul) return; ul.innerHTML=''; currentPedidoItems.forEach((it,idx)=>{ const li=document.createElement('li'); li.style.marginBottom='6px'; li.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
      <input class="edit_codigo" placeholder="Código" value="${escapeAttr(it.codigo||'')}" style="width:110px" />
      <input class="edit_nombre" placeholder="Nombre" value="${escapeAttr(it.name||'')}" style="flex:1" />
      <input class="edit_qty" type="number" min="1" value="${escapeAttr(it.qty||1)}" style="width:80px" />
      <input class="edit_kgs" type="number" min="0" value="${escapeAttr(it.kgs||0)}" style="width:80px" />
      <input class="edit_price" type="number" min="0" value="${escapeAttr(it.price||0)}" style="width:100px" />
      <button class="eliminar_item small">Eliminar</button>
    </div>`; 
    const btnDel = li.querySelector('.eliminar_item');
    btnDel.addEventListener('click', ()=>{ currentPedidoItems.splice(idx,1); refreshPdItems(); });
    li.querySelector('.edit_codigo').addEventListener('input', (e)=> currentPedidoItems[idx].codigo = e.target.value);
    li.querySelector('.edit_nombre').addEventListener('input', (e)=> currentPedidoItems[idx].name = e.target.value);
    li.querySelector('.edit_qty').addEventListener('input', (e)=> currentPedidoItems[idx].qty = Number(e.target.value) || 1);
    li.querySelector('.edit_kgs').addEventListener('input', (e)=> currentPedidoItems[idx].kgs = Number(e.target.value) || 0);
    li.querySelector('.edit_price').addEventListener('input', (e)=> currentPedidoItems[idx].price = Number(e.target.value) || 0);
    ul.appendChild(li);
  }); }

  function renderPedidos(){ const ul=$('pedidosList'); if(!ul) return; ul.innerHTML=''; const q=$('searchPedidos').value.trim().toLowerCase(); state.pedidos.forEach((p,idx)=>{ if(q && !(String(p.id)+''+String(p.numero)+''+String(p.foundation)+''+(p.foundationNIT||'')).toLowerCase().includes(q)) return; const li=document.createElement('li'); li.style.marginBottom='8px'; const created = new Date(p.createdAt).toLocaleString(); li.innerHTML = '<div style=\"display:flex;justify-content:space-between;align-items:center\"><div><strong>'+ (p.numero || '') + ' — ' + (p.id) + '</strong> — '+escapeHtml(p.foundation)+' — $'+(p.total||0) + '</div><div class=\"small\">'+created+'</div></div>'; const info = document.createElement('div'); info.className='small'; info.style.marginTop='6px'; info.innerHTML = 'Llegada: '+(p.horaLlegada||'—')+' | Salida: '+(p.horaSalida||'—')+' | Conductor: '+(p.driver?.name||'—'); li.appendChild(info);

    const row = document.createElement('div'); row.className='actions-row'; row.style.marginTop='8px';

    const btnEdit = document.createElement('button'); btnEdit.textContent='Editar'; btnEdit.className='primary'; btnEdit.addEventListener('click', ()=>{ abrirEditarPedido(p.id); });
    const btnDup = document.createElement('button'); btnDup.textContent='Duplicar'; btnDup.className='primary'; btnDup.addEventListener('click', ()=>{ abrirDuplicarPedido(p.id); });
    const btnDel = document.createElement('button'); btnDel.textContent='Eliminar'; btnDel.className='primary'; btnDel.addEventListener('click', ()=>{ if(!confirm('Eliminar pedido?')) return; state.pedidos = state.pedidos.filter(x=> x.id !== p.id); save(); renderPedidos(); registrarAccion('eliminar_pedido',{id:p.id}); });
    const btnExport = document.createElement('button'); btnExport.textContent='Exportar'; btnExport.className='primary'; btnExport.addEventListener('click', ()=> exportPedidoAsImageAndPDF(p));

    row.appendChild(btnEdit); row.appendChild(btnDup); row.appendChild(btnDel); row.appendChild(btnExport);
    li.appendChild(row);

    ul.appendChild(li);
  }); }

  // Export (same as before)
  function exportPedidoAsImageAndPDF(pedido){
    const wrap = document.createElement('div');
    wrap.style.width = '1123px';
    wrap.style.minHeight = '794px';
    wrap.style.background = '#fff';
    wrap.style.padding = '28px';
    wrap.style.boxSizing = 'border-box';
    wrap.style.fontFamily = 'Inter, Arial, sans-serif';
    wrap.style.color = '#0f172a';

    const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
    const left = document.createElement('div'); left.innerHTML = '<h2 style="margin:0">Pedido '+escapeHtml(pedido.numero)+'</h2><div class="small">Creado: '+new Date(pedido.createdAt).toLocaleString()+'</div>';
    header.appendChild(left);
    wrap.appendChild(header);

    const info = document.createElement('div'); info.style.display='grid'; info.style.gridTemplateColumns='1fr 1fr'; info.style.gap='8px'; info.style.marginTop='12px';
    info.innerHTML = '<div><b>Fundación:</b> '+escapeHtml(pedido.foundation||'')+'<br><b>NIT:</b> '+escapeHtml(pedido.foundationNIT||'')+'</div>'+
                     '<div><b>Punto / Dirección:</b> '+(pedido.point? (escapeHtml(pedido.point.barrio) + ' — '+escapeHtml(pedido.point.localidad||'')+' — '+escapeHtml(pedido.point.ciudad||'')) : '')+'<br><b>Contactos:</b> '+((pedido.point && (pedido.point.tel1||pedido.point.tel2))? escapeHtml(pedido.point.tel1||'') + ' ' + escapeHtml(pedido.point.tel2||'') : '')+'<br><b>Encargada:</b> '+escapeHtml(pedido.point?.encargada||'')+'</div>';
    wrap.appendChild(info);

    const transport = document.createElement('div'); transport.style.marginTop='12px'; transport.innerHTML = '<b>Conductor:</b> '+(pedido.driver?.name||'--')+' &nbsp; <b>Placa:</b> '+(pedido.driver? (pedido.driver.plate || (pedido.plate? pedido.plate.plate:'')) : (pedido.plate? pedido.plate.plate:''))+'<br><b>Peaje:</b> $'+(pedido.peaje||0)+' &nbsp; <b>Transporte:</b> $'+(pedido.trans||0);
    wrap.appendChild(transport);

    const tbl = document.createElement('table'); tbl.style.width='100%'; tbl.style.borderCollapse='collapse'; tbl.style.marginTop='12px';
    const thead = document.createElement('thead'); thead.innerHTML = '<tr><th style="border:1px solid #ddd;padding:6px">Item</th><th style="border:1px solid #ddd;padding:6px">Embalaje</th><th style="border:1px solid #ddd;padding:6px">Cantidad</th><th style="border:1px solid #ddd;padding:6px">Kilos</th><th style="border:1px solid #ddd;padding:6px">Precio</th></tr>';
    tbl.appendChild(thead);
    const tb = document.createElement('tbody');
    (pedido.items||[]).forEach(it=>{
      const tr = document.createElement('tr');
      tr.innerHTML = '<td style="border:1px solid #ddd;padding:6px">'+escapeHtml(it.name||'')+'</td>'+
                     '<td style="border:1px solid #ddd;padding:6px">'+escapeHtml(it.pack||'')+'</td>'+
                     '<td style="border:1px solid #ddd;padding:6px;text-align:right">'+(it.qty||1)+'</td>'+
                     '<td style="border:1px solid #ddd;padding:6px;text-align:right">'+(it.kgs||0)+'</td>'+
                     '<td style="border:1px solid #ddd;padding:6px;text-align:right">$'+(it.price||0)+'</td>';
      tb.appendChild(tr);
    });
    tbl.appendChild(tb);
    wrap.appendChild(tbl);

    const sumDiv = document.createElement('div'); sumDiv.style.marginTop='12px'; sumDiv.style.textAlign='right'; const subtotal = (pedido.items||[]).reduce((s,it)=>s + ((it.price||0)*(it.qty||1)),0); sumDiv.innerHTML = '<div><b>Subtotal:</b> $'+subtotal+'</div><div><b>Peaje:</b> $'+(pedido.peaje||0)+'</div><div><b>Transporte:</b> $'+(pedido.trans||0)+'</div><div style="font-size:18px;margin-top:6px"><b>Total:</b> $'+(pedido.total||0)+'</div>';
    wrap.appendChild(sumDiv);

    document.body.appendChild(wrap);
    wrap.style.position='fixed'; wrap.style.left='200%';

    html2canvas(wrap, {scale:2}).then(canvas=>{
      const link = document.createElement('a'); link.download = (pedido.numero || pedido.id) + '.png'; link.href = canvas.toDataURL('image/png'); link.click();
      const dataUrl = canvas.toDataURL('image/png'); const win = window.open(''); if(win){ win.document.write('<html><head><title>'+pedido.numero+'</title></head><body style="margin:0"><img src="'+dataUrl+'" style="width:100%"></body></html>'); win.document.close(); }
      setTimeout(()=>{ document.body.removeChild(wrap); },500);
      registrarAccion('export_pedido_image',{id:pedido.id});
    }).catch(err=>{ alert('Error al generar imagen: '+err); document.body.removeChild(wrap); });
  }

  function renderAudit(){ const box=$('auditList'); if(!box) return; box.innerHTML=''; const uf=$('auditUserFilter').value.trim().toLowerCase(); const df=$('auditDateFilter').value; state.audit.forEach(a=>{ const dstr=new Date(a.fecha).toISOString().slice(0,10); if(uf && !a.usuario.toLowerCase().includes(uf)) return; if(df && dstr!==df) return; const d=document.createElement('div'); d.style.marginBottom='8px'; d.innerHTML='<b>['+new Date(a.fecha).toLocaleString()+'] '+a.usuario+'</b> — '+a.accion+' <div class="small">'+escapeHtml(JSON.stringify(a.detalle))+'</div>'; box.appendChild(d); }); }
  $('auditUserFilter').addEventListener('input',renderAudit);
  $('auditDateFilter').addEventListener('change',renderAudit);

  // initial fillers
  fillFundSelects(); fillItemSelect(); fillPackSelect(); fillDriverPlate(); renderFund(); renderItems(); renderPacks(); renderDrivers(); renderPlates(); renderPedidos(); renderAudit();

  // === IMPORT EXCEL handlers (unchanged) ===
  $('btnImportFund').addEventListener('click', ()=>{
    const file = $('excel_fundaciones').files[0];
    if(!file) return alert('Seleccione un archivo Excel.');
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data,{type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet,{header:1});
      rows.forEach((r,i)=>{
        if(i===0) return;
        const nit = String(r[0]||'').trim();
        const name = String(r[1]||'').trim();
        if(!nit||!name) return;
        // block duplicate nit/name
        const existsNit = state.foundations.some(f=> String(f.nit).trim().toLowerCase() === nit.toLowerCase());
        const existsName = state.foundations.some(f=> String(f.name).trim().toLowerCase() === name.toLowerCase());
        if(!existsNit && !existsName){
          state.foundations.push({nit,name,points:[]});
        }
      });
      save(); fillFundSelects(); renderFund(); registrarAccion('importar_fund_excel',{cant:rows.length});
      alert('Fundaciones importadas.');
    };
    reader.readAsArrayBuffer(file);
  });

  $('btnImportItems').addEventListener('click', ()=>{
    const file = $('excel_items').files[0];
    if(!file) return alert('Seleccione un archivo Excel.');
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data,{type:'array'});
      const sheet = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sheet,{header:1});
      rows.forEach((r,i)=>{
        if(i===0) return;
        const ref = String(r[0]||'').trim();
        const name = String(r[1]||'').trim();
        const price = Number(r[2]||0);
        const desc = String(r[3]||'').trim();
        if(!ref||!name) return;
        if(!state.items.some(it=>it.ref===ref)){
          state.items.push({ref,name,desc,price});
        }
      });
      save(); renderItems(); fillItemSelect(); registrarAccion('importar_items_excel',{cant:rows.length});
      alert('Items importados.');
    };
    reader.readAsArrayBuffer(file);
  });

  // === HANDLERS: Create Foundation (with duplicate blocking) ===
  $('f_nit').addEventListener('input', function(){
    const nit = this.value.trim();
    $('f_warn').innerText = '';
    if(!nit) return;
    const f = state.foundations.find(ff => String(ff.nit) === nit);
    if(f){
      $('f_name').value = f.name;
      $('f_warn').innerText = 'NIT ya registrado — mostré el nombre existente.';
    }
  });

  $('btnFundCreate').addEventListener('click', ()=>{
    if(!state.currentUser) return alert('Inicie sesión');
    const nit = $('f_nit').value.trim();
    const name = $('f_name').value.trim();
    if(!nit || !name) return alert('Complete NIT y Nombre');
    // normalize
    const nNit = String(nit).trim().toLowerCase();
    const nName = String(name).trim().toLowerCase();
    const dupNit = state.foundations.some(f=> String(f.nit).trim().toLowerCase() === nNit);
    const dupName = state.foundations.some(f=> String(f.name).trim().toLowerCase() === nName);
    if(dupNit || dupName){
      let msg = 'No se creó. Fundación duplicada por: ';
      if(dupNit) msg += 'NIT ';
      if(dupName) msg += 'Nombre';
      return alert(msg.trim());
    }
    state.foundations.push({nit,name,points:[]});
    save(); fillFundSelects(); renderFund(); registrarAccion('crear_fundacion',{nit,name});
    $('f_nit').value=''; $('f_name').value=''; $('f_warn').innerText='';
  });

  // === HANDLERS: Punto de Envío (with dedupe barrio+ciudad) ===
  // when typing NIT in Punto form, auto-select foundation in selFund and show name
  $('p_fund_nit').addEventListener('input', function(){
    const nit = this.value.trim();
    $('p_warn').innerText = '';
    $('p_fund_info').innerText = '';
    if(!nit){
      // leave selFund as is
      return;
    }
    const idx = state.foundations.findIndex(f => String(f.nit) === nit);
    if(idx >= 0){
      $('selFund').value = idx;
      $('p_fund_info').innerText = state.foundations[idx].name;
    } else {
      $('p_fund_info').innerText = 'NIT no encontrado';
    }
    // update pd_fund if needed (keeps consistency)
    fillFundSelects(); // to ensure pd_fund updated too
  });

  $('btnPointCreate').addEventListener('click', ()=>{
    if(!state.currentUser) return alert('Inicie sesión');
    const fi = Number($('selFund').value);
    const f = state.foundations[fi];
    if(!f) return alert('Seleccione fundación');
    const barrio = $('p_barrio').value.trim();
    const localidad = $('p_localidad').value.trim();
    const ciudad = $('p_ciudad').value.trim();
    const tel1 = $('p_tel1').value.trim();
    const tel2 = $('p_tel2').value.trim();
    const encargada = $('p_encargada').value.trim();
    if(!barrio || !ciudad) return alert('Barrio y Ciudad requeridos');
    // normalize for duplicate check
    const nb = barrio.toLowerCase().trim();
    const nc = ciudad.toLowerCase().trim();
    f.points = f.points || [];
    const dupPoint = f.points.some(p => (String(p.barrio||'').toLowerCase().trim() === nb) && (String(p.ciudad||'').toLowerCase().trim() === nc));
    if(dupPoint){
      $('p_warn').innerText = 'Punto duplicado (mismo barrio + ciudad) — no creado.';
      return;
    }
    const p = {barrio,localidad,ciudad,tel1,tel2,encargada};
    f.points.push(p);
    save(); renderFund(); fillFundSelects(); registrarAccion('crear_punto',{fund:f.name,barrio:p.barrio});
    // clear fields (leave selFund selected)
    $('p_barrio').value=''; $('p_localidad').value=''; $('p_ciudad').value=''; $('p_tel1').value=''; $('p_tel2').value=''; $('p_encargada').value=''; $('p_warn').innerText=''; $('p_fund_nit').value='';
  });

  // === Items / Packs / Drivers / Plates / Create Item ===
  $('btnCreateItem').addEventListener('click', ()=>{ if(!state.currentUser) return alert('Inicie sesión'); const ref=$('item_ref').value.trim(); const name=$('item_name').value.trim(); if(!name) return alert('Nombre requerido'); const desc=$('item_desc').value.trim(); const price=Number($('item_price').value)||0; state.items.push({ref,name,desc,price}); save(); renderItems(); fillItemSelect(); registrarAccion('crear_item',{name}); $('item_ref').value=''; $('item_name').value=''; $('item_desc').value=''; $('item_price').value=''; });
  $('btnAddPack').addEventListener('click', ()=>{ if(!state.currentUser) return alert('Inicie sesión'); const v=$('new_pack').value.trim(); if(!v) return alert('Ingrese nombre'); state.packs.push(v); save(); renderPacks(); $('new_pack').value=''; registrarAccion('crear_embalaje',{pack:v}); });
  $('btnAddDriver').addEventListener('click', ()=>{ if(!state.currentUser) return alert('Inicie sesión'); const d={name:$('drv_name').value.trim(),document:$('drv_doc').value.trim(),phone:$('drv_tel').value.trim(),company:$('drv_cmp').value.trim()}; if(!d.name) return alert('Nombre requerido'); state.drivers.push(d); save(); renderDrivers(); fillDriverPlate(); registrarAccion('crear_conductor',d); $('drv_name').value=''; $('drv_doc').value=''; $('drv_tel').value=''; $('drv_cmp').value=''; });
  $('btnAddPlate').addEventListener('click', ()=>{ if(!state.currentUser) return alert('Inicie sesión'); const p={plate:$('pl_plate').value.trim(),type:$('pl_type').value.trim()}; if(!p.plate) return alert('Placa requerida'); state.plates.push(p); save(); renderPlates(); fillDriverPlate(); registrarAccion('crear_placa',p); $('pl_plate').value=''; $('pl_type').value=''; });

  // === Pedido flow ===
  $('pd_add_item').addEventListener('click', ()=>{ if(!state.currentUser) return alert('Inicie sesión'); const idx = Number($('pd_item_sel').value); if(isNaN(idx) || !state.items[idx]) return alert('Seleccione item'); const pack = $('pd_pack_sel').value || ''; const packQty = Number($('pd_pack_qty').value)||0; const kgs = Number($('pd_kilos').value); if(!kgs) return alert('Kilos obligatorios'); const it = state.items[idx]; const qty = packQty || 1; currentPedidoItems.push({codigo: it.ref || '', name:it.name, price:it.price, qty, pack, kgs}); refreshPdItems(); });
  $('btnAddProducto').addEventListener('click', ()=>{ if(!state.currentUser) return alert('Inicie sesión'); currentPedidoItems.push({codigo:'',name:'',price:0,qty:1,pack:'',kgs:0}); refreshPdItems(); });
  $('pd_fund').addEventListener('change', ()=> fillPedidoPoints());

  // Autocomplete by NIT in Pedido (improved)
  $('pd_nit').addEventListener('input', function(){
    const nitIngresado = this.value.trim();
    $('pd_fund_info').innerText = '';
    if(!nitIngresado) {
      $('pd_fund').value = '';
      fillPedidoPoints();
      return;
    }
    const f = state.foundations.find(ff => String(ff.nit) === nitIngresado);
    if(f){
      $('pd_fund_info').innerText = f.name;
      const idx = state.foundations.findIndex(x=> x.nit === f.nit);
      if(idx>=0){
        $('pd_fund').value = idx;
        fillPedidoPoints();
        // Si la fundación tiene 1 punto, lo seleccionamos automáticamente (fillPedidoPoints hace esto)
      }
    } else {
      $('pd_fund_info').innerText = 'NIT no registrado';
    }
  });

  // Guardar pedido / editar / duplicar
  $('btnAddPedido').addEventListener('click', ()=>{ if(!state.currentUser) return alert('Inicie sesión');
    const nitVal = $('pd_nit').value.trim();
    const fundIndex = $('pd_fund').value !== '' ? Number($('pd_fund').value) : null;
    const f = (fundIndex!==null && state.foundations[fundIndex]) ? state.foundations[fundIndex] : null;
    const pointIndex = Number($('pd_point').value);
    const point = f ? (f.points || [])[pointIndex] : null;
    if(!f) return alert('Seleccione fundación válida');
    if(!point) return alert('Seleccione punto válido');
    if(currentPedidoItems.length===0) return alert('Agregue items');
    const peaje=Number($('pd_peaje').value)||0;
    const trans=Number($('pd_trans').value)||0;
    const subtotal=currentPedidoItems.reduce((s,it)=>s+(it.price||0)*(it.qty||1),0);
    const total=subtotal+peaje+trans;
    if(modoPedido === 'crear' || modoPedido === 'duplicar'){
      const nuevo = {
        id: Date.now(),
        numero: obtenerConsecutivoPedidoPorAnio(),
        foundation: f.name,
        foundationNIT: f.nit,
        point: point,
        items: JSON.parse(JSON.stringify(currentPedidoItems)),
        peaje, trans, subtotal, total,
        driver: null,
        createdAt: new Date().toISOString()
      };
      state.pedidos.unshift(nuevo);
      save();
      registrarAccion('crear_pedido',{id:nuevo.id,foundation:nuevo.foundation,total:nuevo.total});
      alert('Pedido creado: '+nuevo.numero);
    } else if(modoPedido === 'editar'){
      const pedidos = state.pedidos.map(p=>{
        if(p.id === pedidoEditandoId){
          return {
            ...p,
            foundation: f.name,
            foundationNIT: f.nit,
            point: point,
            items: JSON.parse(JSON.stringify(currentPedidoItems)),
            peaje, trans, subtotal, total
          };
        }
        return p;
      });
      state.pedidos = pedidos;
      save();
      registrarAccion('editar_pedido',{id:pedidoEditandoId});
      alert('Pedido modificado.');
    }
    modoPedido = 'crear'; pedidoEditandoId = null;
    currentPedidoItems = [];
    refreshPdItems();
    $('pd_nit').value=''; $('pd_peaje').value=''; $('pd_trans').value='';
    $('formTitle').innerText = 'Crear Pedido';
    $('pedidoModoBadge').innerText = '';
    renderPedidos();
    showSection('recibos');
  });

  // Export image of pedidos list
  $('btnExportPedidoIMG').addEventListener('click', ()=>{
    const node = document.getElementById('pedidosList');
    html2canvas(node).then(canvas=>{
      const link = document.createElement('a');
      link.download = 'pedidos.png';
      link.href = canvas.toDataURL();
      link.click();
    });
  });

  // Admin users
  function renderAdminUsers(){ const ul=$('adm_user_list'); if(!ul) return; ul.innerHTML=''; state.users.forEach((u,i)=>{ const li=document.createElement('li'); li.style.marginBottom='8px'; li.innerHTML = '<b>'+escapeHtml(u.username)+'</b> — '+escapeHtml(u.role); if(state.currentUser && state.currentUser.role==='admin'){ const btnE=document.createElement('button'); btnE.textContent='Editar'; btnE.style.marginLeft='8px'; btnE.addEventListener('click', ()=>{ const newRole=prompt('Rol (admin/general/lector)',u.role); if(newRole){ u.role=newRole; save(); renderAdminUsers(); registrarAccion('editar_usuario',{username:u.username,role:newRole}); } }); const btnD=document.createElement('button'); btnD.textContent='Eliminar'; btnD.style.marginLeft='8px'; btnD.addEventListener('click', ()=>{ if(u.username==='admin') return alert('No eliminar admin principal'); if(!confirm('Eliminar usuario?')) return; state.users.splice(i,1); save(); renderAdminUsers(); registrarAccion('eliminar_usuario',{username:u.username}); }); li.appendChild(btnE); li.appendChild(btnD); } ul.appendChild(li); }); }
  $('adm_add_user').addEventListener('click', ()=>{ if(!state.currentUser || state.currentUser.role!=='admin') return alert('Solo admin'); const user=$('adm_new_user').value.trim(); const pass=$('adm_new_pass').value.trim(); const role=$('adm_new_role').value; if(!user||!pass) return alert('Complete'); if(state.users.some(x=>x.username===user)) return alert('Usuario existe'); state.users.push({username:user,pass,role,fullname:'',phone:'',email:''}); save(); renderAdminUsers(); registrarAccion('crear_usuario',{username:user,role}); alert('Usuario creado'); });

  function renderAll(){ fillFundSelects(); fillItemSelect(); fillPackSelect(); fillDriverPlate(); renderFund(); renderItems(); renderPacks(); renderDrivers(); renderPlates(); renderPedidos(); renderAudit(); renderAdminUsers(); }

  // Edit / Duplicate pedido
  function abrirEditarPedido(id){
    const pedido = state.pedidos.find(p=> p.id === id);
    if(!pedido) return alert('Pedido no encontrado');
    modoPedido = 'editar';
    pedidoEditandoId = id;
    $('formTitle').innerText = 'Editar Pedido — ' + (pedido.numero || '');
    $('pedidoModoBadge').innerText = 'Modo: editar';
    $('pd_nit').value = pedido.foundationNIT || '';
    const fIndex = state.foundations.findIndex(x=> x.nit === pedido.foundationNIT);
    if(fIndex>=0){ $('pd_fund').value = fIndex; fillPedidoPoints(); }
    if(pedido.point){
      const points = (state.foundations[fIndex] && state.foundations[fIndex].points) || [];
      const pIdx = points.findIndex(pp => pp.barrio === pedido.point.barrio && pp.ciudad === pedido.point.ciudad);
      if(pIdx>=0) $('pd_point').value = pIdx;
    }
    currentPedidoItems = JSON.parse(JSON.stringify(pedido.items || []));
    refreshPdItems();
    showSection('recibos');
  }

  function abrirDuplicarPedido(id){
    const pedido = state.pedidos.find(p=> p.id === id);
    if(!pedido) return alert('Pedido no encontrado');
    modoPedido = 'duplicar';
    pedidoEditandoId = null;
    $('formTitle').innerText = 'Duplicar Pedido — ' + (pedido.numero || '');
    $('pedidoModoBadge').innerText = 'Modo: duplicar (no guardado)';
    $('pd_nit').value = pedido.foundationNIT || '';
    const fIndex = state.foundations.findIndex(x=> x.nit === pedido.foundationNIT);
    if(fIndex>=0){ $('pd_fund').value = fIndex; fillPedidoPoints(); }
    if(pedido.point){
      const points = (state.foundations[fIndex] && state.foundations[fIndex].points) || [];
      const pIdx = points.findIndex(pp => pp.barrio === pedido.point.barrio && pp.ciudad === pedido.point.ciudad);
      if(pIdx>=0) $('pd_point').value = pIdx;
    }
    currentPedidoItems = JSON.parse(JSON.stringify(pedido.items || []));
    refreshPdItems();
    showSection('recibos');
  }

  if(state.currentUser){ setCurrentUser(state.currentUser); } else { openLogin(); }

  $('searchPedidos').addEventListener('input', renderPedidos);

  // CSV export
  $('btnExportPedidoCSV').addEventListener('click', ()=>{ const rows=[['id','numero','fundacion','nit','punto','item','pack','qty','kgs','precio','peaje','trans','total','fecha']]; state.pedidos.forEach(p=> p.items.forEach(it=> rows.push([p.id,p.numero,p.foundation,p.foundationNIT,p.point?.barrio||'',it.name,it.pack,it.qty,it.kgs,it.price,p.peaje,p.trans,p.total,p.createdAt]))); const csv = rows.map(r=> r.map(c=> '"'+(''+c).replace(/"/g,'""')+'"').join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='pedidos.csv'; a.click(); URL.revokeObjectURL(url); });

  // small helpers to avoid XSS when injecting strings
  function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }
  function escapeAttr(str){ return escapeHtml(str).replace(/"/g,'&quot;'); }

});
</script>
</body>
</html>
